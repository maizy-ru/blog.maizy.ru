<!DOCTYPE html>
<html lang="ru"
>
<head>
    <title>Использование ansible в Docker контейнерах - blog.maizy.ru</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.maizy.ru/posts/ansible-in-docker">

        <meta name="author" content="Никита Ковалев" />
        <meta name="keywords" content="ansible,docker" />
        <meta name="description" content="Для решения задачи настройки сервера уже давно придумали много вещей лучше, чем просто bash скрипт. Я в частности, использую ansible. Но для создания docker контейнеров по прежнему предлагается механизм который не далеко ушёл от bash скриптов. Мне понадобилось строить на сервере набор контейнеров, причём полностью автоматизировано. Если создание docker images на основе Dockerfile и работа с готовыми контейнерами в ansible решается из коробки, то с настройкой контейнеров через ansible пришлось немного извратиться. Идея простая: сделать базовый image в docker в котором через Dockerfile устанавливается только ansible, засинхронизировать с локальной машины на хост машину все файлы, нужные для ansible - роли, настройки и таски, создать контейнер, засинхронизированные настройки подключить в volume внутри контейнера, запустить ansible-playbook через docker exec, готовые контейнеры при необходимости коммитяться и используются как основа для других контейнеров. Плюсы ansible здесь – идемпотентность, готовые модули и возможность использовать некоторые роли, как для хост машин, так и для контейнеров. Например, у меня есть абстрактная роль nginx и отдельная роль поверх неё nginx_container со спецификой для контейнеров. То что получилось и подробности работы можно посмотреть в репозитории scala-moscow/deploy." />

        <meta property="og:site_name" content="blog.maizy.ru" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Использование ansible в Docker контейнерах"/>
        <meta property="og:url" content="http://blog.maizy.ru/posts/ansible-in-docker"/>
        <meta property="og:description" content="Для решения задачи настройки сервера уже давно придумали много вещей лучше, чем просто bash скрипт. Я в частности, использую ansible. Но для создания docker контейнеров по прежнему предлагается механизм который не далеко ушёл от bash скриптов. Мне понадобилось строить на сервере набор контейнеров, причём полностью автоматизировано. Если создание docker images на основе Dockerfile и работа с готовыми контейнерами в ansible решается из коробки, то с настройкой контейнеров через ansible пришлось немного извратиться. Идея простая: сделать базовый image в docker в котором через Dockerfile устанавливается только ansible, засинхронизировать с локальной машины на хост машину все файлы, нужные для ansible - роли, настройки и таски, создать контейнер, засинхронизированные настройки подключить в volume внутри контейнера, запустить ansible-playbook через docker exec, готовые контейнеры при необходимости коммитяться и используются как основа для других контейнеров. Плюсы ansible здесь – идемпотентность, готовые модули и возможность использовать некоторые роли, как для хост машин, так и для контейнеров. Например, у меня есть абстрактная роль nginx и отдельная роль поверх неё nginx_container со спецификой для контейнеров. То что получилось и подробности работы можно посмотреть в репозитории scala-moscow/deploy."/>
        <meta property="article:published_time" content="2015-04-02" />
            <meta property="article:section" content="Tech" />
            <meta property="article:tag" content="ansible" />
            <meta property="article:tag" content="docker" />
            <meta property="article:author" content="Никита Ковалев" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.maizy.ru/theme/css/bootstrap.yeti.min.css" type="text/css"/>
    <link href="http://blog.maizy.ru/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.maizy.ru/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.maizy.ru/theme/css/style.css" type="text/css"/>
        <link href="http://blog.maizy.ru/static/css/custom.css" rel="stylesheet">

        <link href="http://blog.maizy.ru/feeds/category/tech/atom.xml" type="application/atom+xml" rel="alternate"
              title="blog.maizy.ru"/>
        <link href="http://blog.maizy.ru/feeds/category/tech/rss.xml" type="application/rss+xml" rel="alternate"
              title="blog.maizy.ru"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.maizy.ru/" class="navbar-brand">
blog.maizy.ru            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://blog.maizy.ru/life">Life</a>
                        </li>
                        <li class="active">
                            <a href="http://blog.maizy.ru/">Tech</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://blog.maizy.ru/archives"><i class="fa fa-th-list"></i><span class="icon-label">Архив</span></a></li>
              <li><a href="http://blog.maizy.ru/feeds/category/tech/rss.xml"><i class="fa fa-rss"></i><span class="icon-label">RSS</span></a></li>
              <li><a href="http://blog.maizy.ru/about"><i class="fa fa-bed"></i><span class="icon-label">О блоге</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-offset-1 col-md-10 col-lg-8 col-lg-offset-2">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.maizy.ru/posts/ansible-in-docker"
                       rel="bookmark"
                       title="Permalink to Использование ansible в Docker контейнерах">
                        Использование ansible в Docker контейнерах
                    </a>
                </h1>
                <div class="article-info">
<footer class="post-info">
    <div class="published">
        <time datetime="2015-04-02T00:00:00+03:00"> 02.04.2015</time>
    </div>



<div class="tags">
<i class="fa fa-tags"></i>&nbsp;
	<a href="http://blog.maizy.ru/tag/ansible">ansible</a>
        /
	<a href="http://blog.maizy.ru/tag/docker">docker</a>
</div>
    
</footer><!-- /.post-info -->                </div>
            </header>
            <div class="entry-content">
                <p>Для решения задачи настройки сервера уже давно придумали много вещей лучше, чем просто bash скрипт. Я в частности, использую <a href="http://docs.ansible.com/index.html">ansible</a>. Но для создания docker контейнеров <a href="https://docs.docker.com/reference/builder/">по прежнему предлагается</a> механизм который не далеко ушёл от bash скриптов.</p>
<p>Мне понадобилось строить на сервере набор контейнеров, причём полностью автоматизировано. Если создание docker images на основе Dockerfile и работа с готовыми контейнерами в ansible решается из коробки, то с настройкой контейнеров через ansible пришлось немного извратиться.</p>
<p>Идея простая:</p>
<ul>
<li>сделать базовый image в docker в котором через Dockerfile устанавливается только ansible,</li>
<li>засинхронизировать с локальной машины на хост машину все файлы, нужные для ansible - роли, настройки и таски,</li>
<li>создать контейнер,</li>
<li>засинхронизированные настройки подключить в volume внутри контейнера,</li>
<li>запустить ansible-playbook через docker exec,</li>
<li>готовые контейнеры при необходимости коммитяться и используются как основа для других контейнеров.</li>
</ul>
<p>Плюсы ansible здесь – идемпотентность, готовые модули и возможность использовать некоторые роли, как для хост машин, так и для контейнеров. Например, у меня есть абстрактная роль <code>nginx</code> и отдельная роль поверх неё <code>nginx_container</code> со спецификой для контейнеров.</p>
<p>То что получилось и подробности работы можно посмотреть в <a href="https://github.com/scala-moscow/deploy">репозитории scala-moscow/deploy</a>.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'blogmaizyru'; // required: replace example with your forum shortname

                    var disqus_identifier = 'ansible-in-docker';
                var disqus_url = 'http://blog.maizy.ru/posts/ansible-in-docker';

            var disqus_config = function () {
                this.language = "ru";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row footnotes">
         <div class="col-xs-10">&copy; 2015-2016 Никита Ковалев
            &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>
            &middot; Theme <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>.         </div>
        <div class="col-xs-2">
          <p class="pull-right">
            <i class="fa fa-rss"></i>
            <a href="http://blog.maizy.ru/feeds/category/tech/rss.xml">rss</a>
          </p>
        </div>
      </div>
   </div>
</footer>
<script src="http://blog.maizy.ru/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.maizy.ru/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.maizy.ru/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'blogmaizyru'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-392618-8', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

</body>
</html>